import{a as h}from"./index-D5pz3NtM.js";import{z as l}from"./vendor-DTIOB2Rm.js";const u=(s,t,e)=>{const i=s[t];return i?typeof i=="function"?i():Promise.resolve(i):new Promise((o,r)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(r.bind(null,new Error("Unknown variable dynamic import: "+t+(t.split("/").length!==e?". Note that variables only represent file names one level deep.":""))))})};class d{STORAGE_KEY="exhibit_records";PREFS_KEY="user_preferences";db=null;constructor(){this.initIndexedDB()}async initIndexedDB(){return new Promise((t,e)=>{const i=indexedDB.open("ExhibitDB",1);i.onerror=()=>e(i.error),i.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains("exhibits")||r.createObjectStore("exhibits",{keyPath:"id"})},i.onsuccess=()=>{this.db=i.result,t()}})}async saveExhibitRecord(t){return this.db||await this.initIndexedDB(),new Promise((e,i)=>{const n=this.db.transaction(["exhibits"],"readwrite").objectStore("exhibits").put(t);n.onsuccess=()=>e(),n.onerror=()=>i(n.error)})}savePreferences(t){try{localStorage.setItem(this.PREFS_KEY,JSON.stringify(t))}catch(e){console.error("保存偏好设置失败:",e)}}getPreferences(){try{const t=localStorage.getItem(this.PREFS_KEY);return t?JSON.parse(t):{}}catch{return{}}}async cleanupOldRecords(){if(!this.db)return;const t=Date.now()-30*24*60*60*1e3,o=this.db.transaction(["exhibits"],"readwrite").objectStore("exhibits").openCursor();o.onsuccess=r=>{const n=r.target.result;n&&(n.value.visitTime<t&&n.delete(),n.continue())}}async getFavoriteRecords(){return this.db||await this.initIndexedDB(),new Promise((t,e)=>{const r=this.db.transaction(["exhibits"],"readonly").objectStore("exhibits").getAll();r.onsuccess=()=>{const n=r.result;t(n.filter(a=>a.favorite))},r.onerror=()=>e(r.error)})}async getVisitHistory(){return this.db||await this.initIndexedDB(),new Promise((t,e)=>{const r=this.db.transaction(["exhibits"],"readonly").objectStore("exhibits").getAll();r.onsuccess=()=>{const n=r.result;t(n.sort((a,c)=>c.visitTime-a.visitTime))},r.onerror=()=>e(r.error)})}}const b=new d,g=l("exhibit",{state:()=>({exhibits:[],currentExhibit:null,loading:!1,error:null}),actions:{async loadExhibits(){this.loading=!0;try{const s=await h(()=>import("./exhibits-sDdSCI0f.js"),[]);this.exhibits=s.default}catch{this.error="加载展品失败"}finally{this.loading=!1}},setCurrentExhibit(s){this.currentExhibit=s},async loadExhibitDetail(s){this.loading=!0;try{if(this.exhibits.length>0&&(this.currentExhibit=this.exhibits.find(e=>e.id===s)||null,this.currentExhibit))return;const t=await u(Object.assign({}),`../assets/data/exhibits/${s}.json`,5);this.currentExhibit=t.default}catch{this.error="加载展品详情失败",this.currentExhibit=null}finally{this.loading=!1}},async toggleFavorite(s){const t=this.exhibits.find(e=>e.id===s);if(t)try{await b.saveExhibitRecord({id:s,visitTime:Date.now(),favorite:!t.favorite}),t.favorite=!t.favorite}catch(e){console.error("收藏操作失败:",e)}}}});export{b as s,g as u};
